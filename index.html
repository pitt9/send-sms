<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SMS ‚Äì Cr√©ation de compte</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .card { max-width: 520px; padding: 18px; border: 1px solid #e5e5e5; border-radius: 12px; }
    label { display:block; margin-bottom:8px; font-weight:700; }
    input { width:100%; padding:12px; font-size:16px; border:1px solid #ddd; border-radius:10px; }
    button { margin-top:12px; padding:12px 14px; font-size:16px; border:0; border-radius:10px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .msg { margin-top:12px; padding:10px; border-radius:10px; display:none; }
    .ok { background:#ecfdf3; border:1px solid #a7f3d0; color:#065f46; }
    .err { background:#fef2f2; border:1px solid #fecaca; color:#7f1d1d; }
    .tiny { font-size:12px; color:#666; margin-top:6px; }
  </style>
</head>

<body>
  <div class="card">
    <h2 style="margin:0 0 12px;">üì© Envoyer le SMS ‚ÄúCr√©er un compte‚Äù</h2>

    <form id="smsForm">
      <label for="phone">Num√©ro de t√©l√©phone</label>
      <input
        id="phone"
        name="phone"
        type="tel"
        inputmode="tel"
        autocomplete="tel"
        placeholder="Ex: 079 123 45 67 ou +41 79 123 45 67"
        required
      />
      <div class="tiny">Le num√©ro est normalis√© en +41‚Ä¶ automatiquement.</div>

      <button id="sendBtn" type="submit">Envoyer</button>
      <div id="result" class="msg"></div>
    </form>
  </div>

  <script>
    const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/4zovlmjo1i3gtax2a11y6800p5ohxnbe";
    const SHARED_SECRET = ""; // optionnel

    function normalizePhone(raw) {
      let s = (raw || "").trim();
      s = s.replace(/[^\d+]/g, "");
      if (s.startsWith("0041")) s = "+41" + s.slice(4);
      if (s.startsWith("0") && s.length >= 9) s = "+41" + s.slice(1);
      if (s.startsWith("41") && !s.startsWith("+41")) s = "+" + s;
      return s;
    }

    function showMessage(el, text, ok) {
      el.textContent = text;
      el.className = "msg " + (ok ? "ok" : "err");
      el.style.display = "block";
    }

    document.getElementById("smsForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const phoneInput = document.getElementById("phone");
      const sendBtn = document.getElementById("sendBtn");
      const result = document.getElementById("result");

      const phone = normalizePhone(phoneInput.value);

      if (!phone.startsWith("+") || phone.length < 10) {
        showMessage(result, "Num√©ro invalide. Exemple: +41 79 123 45 67", false);
        return;
      }

      sendBtn.disabled = true;
      result.style.display = "none";

      try {
        const payload = {
          phone,
          phone_raw: phoneInput.value,
          source: "secretariat_form",
          ts: new Date().toISOString(),
          secret: SHARED_SECRET || undefined
        };

        const res = await fetch(MAKE_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        // lire la r√©ponse (utile pour debug)
        const text = await res.text().catch(() => "");

        if (!res.ok) throw new Error(`Webhook erreur ${res.status}. ${text}`);

        showMessage(result, `‚úÖ Envoy√© √† ${phone}.`, true);
        phoneInput.value = "";
        phoneInput.focus();
      } catch (err) {
        console.error(err);
        showMessage(result, "‚ùå √âchec. Ouvre la console (F12) ‚Üí onglet Console/Network pour voir l‚Äôerreur (souvent CORS).", false);
      } finally {
        sendBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
