<script>
  const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/4zovlmjo1i3gtax2a11y6800p5ohxnbe";
  const SHARED_SECRET = "";

  function normalizePhone(raw) {
    let s = (raw || "").trim();
    s = s.replace(/[^\d+]/g, "");

    if (s.startsWith("0041")) s = "+41" + s.slice(4);
    if (s.startsWith("0") && s.length >= 9) s = "+41" + s.slice(1);
    if (s.startsWith("41") && !s.startsWith("+41")) s = "+" + s;

    return s;
  }

  function showMessage(el, text, ok) {
    el.textContent = text;
    el.className = "msg " + (ok ? "ok" : "err");
    el.style.display = "block";
  }

  document.getElementById("smsForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const phoneInput = document.getElementById("phone");
    const sendBtn = document.getElementById("sendBtn");
    const result = document.getElementById("result");

    const phone = normalizePhone(phoneInput.value);

    if (!phone.startsWith("+") || phone.length < 10) {
      showMessage(result, "Numéro invalide. Essaie un format comme +41 79 123 45 67.", false);
      return;
    }

    sendBtn.disabled = true;
    result.style.display = "none";

    try {
      const payload = {
        phone,
        phone_raw: phoneInput.value,
        source: "secretariat_form",
        ts: new Date().toISOString(),
        secret: SHARED_SECRET || undefined
      };

      const res = await fetch(MAKE_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`Webhook erreur ${res.status}. ${text}`);
      }

      showMessage(result, `✅ Envoyé à ${phone}.`, true);
      phoneInput.value = "";
      phoneInput.focus();
    } catch (err) {
      showMessage(result, "❌ Échec d’envoi. Ouvre la console (F12) pour voir l’erreur exacte.", false);
      console.error(err);
    } finally {
      sendBtn.disabled = false;
    }
  });
</script>
